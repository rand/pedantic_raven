name: Tests

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'

    - name: Run unit tests
      run: go test ./... -short -v

    - name: Run unit tests with coverage
      run: go test ./... -short -coverprofile=coverage.txt -covermode=atomic

    - name: Upload coverage
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.txt
        fail_ci_if_error: false

  e2e-tests-mock:
    name: E2E Tests (Mock)
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'

    - name: Run e2e tests with mocks
      run: go test ./internal/editor -run 'TestGLiNERE2E.*' -v
      env:
        GLINER_E2E_SKIP_DOCKER: "true"

  # E2E Docker tests are DISABLED in CI due to long model download times (~6+ min)
  # Run them locally with: docker-compose up -d gliner && go test ./internal/editor -run TestGLiNERE2E_A2
  #
  # e2e-tests-integration:
  #   name: E2E Tests (Integration with Docker)
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Check out code
  #     uses: actions/checkout@v4
  #   - name: Set up Go
  #     uses: actions/setup-go@v5
  #     with:
  #       go-version: '1.25'
  #   - name: Set up Python
  #     uses: actions/setup-python@v5
  #     with:
  #       python-version: '3.11'
  #   - name: Install Docker Compose
  #     run: sudo apt-get update && sudo apt-get install -y docker-compose
  #   - name: Start GLiNER service
  #     run: |
  #       docker-compose up -d gliner
  #       timeout 360 bash -c 'until curl -sf http://localhost:8765/health | grep -q "\"model_loaded\":true"; do sleep 10; done'
  #   - name: Run e2e tests with real service
  #     run: go test ./internal/editor -run 'TestGLiNERE2E_A2_DockerServiceLifecycle' -v
  #   - name: Stop GLiNER service
  #     if: always()
  #     run: docker-compose down -v

  all-tests-passing:
    name: All Tests Passing
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-tests-mock]

    steps:
    - name: All tests passed
      run: echo "All test suites passed successfully!"
