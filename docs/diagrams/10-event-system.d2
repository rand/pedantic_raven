# Event System Architecture
# PubSub broker with 40+ domain event types

direction: right

# Event Publishers (left side)
publishers: {
  label: "Event Publishers"
  style: {
    fill: "#EBF5FB"
    stroke: "#3498DB"
    stroke-width: 2
  }

  editor: {
    label: "Editor\n• SemanticAnalysisStarted\n• SemanticAnalysisComplete\n• FileOpened\n• FileSaved"
    shape: rectangle
    style: {
      fill: "#3498DB"
      font-color: "#FFFFFF"
    }
  }

  memory_list: {
    label: "Memory List\n• SearchStarted\n• ResultsReceived\n• MemorySelected"
    shape: rectangle
    style: {
      fill: "#2ECC71"
      font-color: "#FFFFFF"
    }
  }

  memory_detail: {
    label: "Memory Detail\n• MemoryCreated\n• MemoryUpdated\n• MemoryDeleted\n• LinkCreated"
    shape: rectangle
    style: {
      fill: "#27AE60"
      font-color: "#FFFFFF"
    }
  }

  mnemosyne_client: {
    label: "mnemosyne Client\n• ConnectionStatusChanged\n• OfflineModeEntered\n• SyncStarted\n• SyncComplete"
    shape: rectangle
    style: {
      fill: "#C0392B"
      font-color: "#FFFFFF"
    }
  }

  analyzer: {
    label: "Analyzer\n• AnalysisStarted\n• PatternDiscovered\n• ReportGenerated"
    shape: rectangle
    style: {
      fill: "#E67E22"
      font-color: "#FFFFFF"
    }
  }

  orchestrator: {
    label: "Orchestrator\n• AgentStarted\n• AgentProgress\n• AgentCompleted\n• ProposalGenerated"
    shape: rectangle
    style: {
      fill: "#9B59B6"
      font-color: "#FFFFFF"
      stroke-dash: 3
    }
  }
}

# Central PubSub Broker
broker: {
  label: "PubSub Broker\n(Event Hub)"
  shape: hexagon
  style: {
    fill: "#34495E"
    stroke: "#2C3E50"
    stroke-width: 4
    font-color: "#ECF0F1"
  }

  subscriptions: {
    label: "Subscription Registry\n• Type-specific\n• Global\n• Thread-safe (RWMutex)"
    shape: rectangle
    style: {
      fill: "#7F8C8D"
      font-color: "#FFFFFF"
    }
  }

  router: {
    label: "Event Router\n• Non-blocking publish\n• Concurrent dispatch\n• Error isolation"
    shape: rectangle
    style: {
      fill: "#95A5A6"
      font-color: "#FFFFFF"
    }
  }
}

# Event Subscribers (right side)
subscribers: {
  label: "Event Subscribers"
  style: {
    fill: "#FEF9E7"
    stroke: "#F39C12"
    stroke-width: 2
  }

  context_panel: {
    label: "Context Panel\n• SemanticAnalysisComplete\n→ Update display"
    shape: rectangle
    style: {
      fill: "#F39C12"
      font-color: "#FFFFFF"
    }
  }

  status_bar: {
    label: "Status Bar\n• ConnectionStatusChanged\n• SyncStarted/Complete\n→ Update status"
    shape: rectangle
    style: {
      fill: "#F8C471"
      font-color: "#7D6608"
    }
  }

  graph_viz: {
    label: "Graph Visualization\n• MemoryCreated/Updated\n• LinkCreated\n→ Refresh graph"
    shape: rectangle
    style: {
      fill: "#16A085"
      font-color: "#FFFFFF"
    }
  }

  search_index: {
    label: "Search Index\n• MemoryCreated/Updated\n→ Re-index"
    shape: rectangle
    style: {
      fill: "#D68910"
      font-color: "#FFFFFF"
    }
  }

  notification: {
    label: "Notification System\n• AgentCompleted\n• SyncComplete\n→ Toast messages"
    shape: rectangle
    style: {
      fill: "#F5B041"
      font-color: "#7D6608"
    }
  }

  logger: {
    label: "Logger\n• All events (global sub)\n→ Audit trail"
    shape: rectangle
    style: {
      fill: "#7F8C8D"
      font-color: "#FFFFFF"
    }
  }
}

# Publisher → Broker connections
publishers.editor -> broker: "Publish" {
  style: {
    stroke: "#3498DB"
    stroke-width: 2
  }
}

publishers.memory_list -> broker: "Publish" {
  style: {
    stroke: "#2ECC71"
    stroke-width: 2
  }
}

publishers.memory_detail -> broker: "Publish" {
  style: {
    stroke: "#27AE60"
    stroke-width: 2
  }
}

publishers.mnemosyne_client -> broker: "Publish" {
  style: {
    stroke: "#C0392B"
    stroke-width: 2
  }
}

publishers.analyzer -> broker: "Publish" {
  style: {
    stroke: "#E67E22"
    stroke-width: 2
  }
}

publishers.orchestrator -> broker: "Publish (Planned)" {
  style: {
    stroke: "#9B59B6"
    stroke-width: 2
    stroke-dash: 3
  }
}

# Broker internals
broker.subscriptions -> broker.router

# Broker → Subscriber connections
broker -> subscribers.context_panel: "Notify" {
  style: {
    stroke: "#F39C12"
    stroke-width: 2
  }
}

broker -> subscribers.status_bar: "Notify" {
  style: {
    stroke: "#F8C471"
    stroke-width: 2
  }
}

broker -> subscribers.graph_viz: "Notify" {
  style: {
    stroke: "#16A085"
    stroke-width: 2
  }
}

broker -> subscribers.search_index: "Notify" {
  style: {
    stroke: "#D68910"
    stroke-width: 2
  }
}

broker -> subscribers.notification: "Notify" {
  style: {
    stroke: "#F5B041"
    stroke-width: 2
  }
}

broker -> subscribers.logger: "Notify (all)" {
  style: {
    stroke: "#7F8C8D"
    stroke-width: 2
  }
}

# Event flow example
example_flow: {
  near: bottom-center
  label: "Example Event Flow"
  style: {
    fill: "#FFFFFF"
    stroke: "#34495E"
    stroke-width: 2
  }

  step1: {
    label: "1. User saves file in Editor"
    shape: rectangle
    style: {
      fill: "#ECF0F1"
    }
  }

  step2: {
    label: "2. Editor publishes FileSaved event"
    shape: rectangle
    style: {
      fill: "#D5DBDB"
    }
  }

  step3: {
    label: "3. Broker routes to subscribers"
    shape: rectangle
    style: {
      fill: "#BDC3C7"
    }
  }

  step4: {
    label: "4. Context panel updates\n   Status bar shows 'Saved'\n   Logger records event"
    shape: rectangle
    style: {
      fill: "#95A5A6"
      font-color: "#FFFFFF"
    }
  }

  step1 -> step2 -> step3 -> step4
}

# Event categories
categories: {
  near: top-right
  label: "Event Categories (40+ types)"
  shape: rectangle
  style: {
    fill: "#FFFACD"
    stroke: "#F39C12"
    stroke-width: 2
  }

  editor_events: {
    label: "Editor (8 types)"
    shape: text
    style: {
      font-color: "#3498DB"
    }
  }

  memory_events: {
    label: "Memory (12 types)"
    shape: text
    style: {
      font-color: "#27AE60"
    }
  }

  connection_events: {
    label: "Connection (6 types)"
    shape: text
    style: {
      font-color: "#C0392B"
    }
  }

  analysis_events: {
    label: "Analysis (5 types)"
    shape: text
    style: {
      font-color: "#E67E22"
    }
  }

  orchestration_events: {
    label: "Orchestration (9 types)"
    shape: text
    style: {
      font-color: "#9B59B6"
    }
  }
}

# Benefits
benefits: {
  near: top-left
  label: "Benefits of Event-Driven Architecture"
  shape: rectangle
  style: {
    fill: "#E8F8F5"
    stroke: "#27AE60"
    stroke-width: 2
  }

  decoupling: {
    label: "✓ Decoupled components"
    shape: text
  }

  reactive: {
    label: "✓ Reactive UI updates"
    shape: text
  }

  testable: {
    label: "✓ Easily testable"
    shape: text
  }

  extensible: {
    label: "✓ Extensible (add subscribers)"
    shape: text
  }

  concurrent: {
    label: "✓ Concurrent event handling"
    shape: text
  }

  isolated: {
    label: "✓ Error isolation"
    shape: text
  }
}
